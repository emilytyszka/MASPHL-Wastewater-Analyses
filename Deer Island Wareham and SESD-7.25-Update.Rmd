---
title: "Deer Island, Wareham, and SESD Wastewater Findings - Biobot vs. MA-SPHL"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  classoption: landscape
header-includes:
- \usepackage{titling}
- \usepackage{wrapfig}
- \usepackage{lipsum}
- \usepackage{pdflscape}
- \pretitle{\begin{center} \includegraphics[width=2in,height=2in]{1200px-MassDPH_svg.png}\LARGE\\}
- \posttitle{\end{center}}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

#Load in Libraries
library(readxl)
library(plyr)
library(dplyr)
library(arsenal)
library(ggplot2)
library(writexl)
library(openxlsx)
library(lubridate) 
library(data.table)
library(kableExtra)
library(tidyr)
library(janitor)
library(scales)
library(kableExtra)
library(tinytex)
library(yaml)
library(ggpubr)
library(cowplot)
library(zoo)
library(formattable)
library(treemap)
library(viridis)
library(paletteer)
library(rlist)
library(magrittr)
library(mosaic)
library(tidyverse)

```

```{r, include = F}

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir= normalizePath('..'))
knitr::opts_chunk$set(error = FALSE)

defOut <- knitr::knit_hooks$get("plot")  # save the default plot hook 
knitr::knit_hooks$set(plot = function(x, options) {  # set new plot hook ...
  x <- defOut(x, options)  # first apply the default hook
  if(!is.null(options$wrapfigure)) {  # then, if option wrapfigure is given ...
    # create the new opening string for the wrapfigure environment ...
    wf <- sprintf("\\begin{wrapfigure}{%s}{%g\\textwidth}", options$wrapfigure[[1]], options$wrapfigure[[2]])
    x  <- gsub("\\begin{figure}", wf, x, fixed = T)  # and replace the default one with it.
    x  <- gsub("{figure}", "{wrapfigure}", x, fixed = T)  # also replace the environment ending
  }
  return(x)
})
```

# Summary

For all data in this report

-   SARS-CoV-2 concentrations are shown in copies/L, marked with date of collection.

-   Percent changes are calculated based on the concentration change from the previous measurement.

-   5-day rolling averages cover a day and the 4 samples prior - so the rolling average for sample n expresses the mean SARS-CoV-2 concentration in water samples from n-4 to n.

```{r setup and summary, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

# Pull in Data
Data<-read_excel(here::here("J:/Wastewater Surveillance/Emily/Deer Island Wareham and SESD/Data","DataClean-7-25.xlsx")) #data from 2019 to 2021; NAs are blanks so we're fixing that
DataSD <- Data #for the sake of standard deviation, everything is in triplicate with its MHV percents. Saving it this way.
Data <- distinct(Data, `Collection Date`, Site, Laboratory, `Normalized Concentration [copies/L]`, .keep_all= TRUE)
Data$`Collection Date` <- as.Date(Data$`Collection Date`, format="%Y-%m-%d") #as date

# Turn off/on: multiply by 100
#Data$`Normalized Concentration [copies/L]` <- ifelse(Data$`Laboratory`=="MA-SPHL", 50*Data$`Normalized Concentration [copies/L]`, ifelse(Data$`Laboratory`=="Biobot", Data$`Normalized Concentration [copies/L]`, NA))

# Add Percents
Data <- mutate(Data, Row = 1:n()) %>%
  group_by(Site, Laboratory) %>%
  mutate(Percent_Change = (lag(`Normalized Concentration [copies/L]`)-`Normalized Concentration [copies/L]`)/
           lag(`Normalized Concentration [copies/L]`) * -1) %>% ungroup
Data$Percent_Change2 <- Data$Percent_Change
Data$Percent_Change <- Data$Percent_Change*100
# Table
Data2 <- subset(Data, select = -c(Row, Percent_Change2))

knitr::kable(head(Data2), caption = "Data Summary") %>%
  kable_styling("bordered", position = "center") %>%
  kable_styling(latex_options="scale_down")

```

\pagebreak

## High Standard Deviation MHV Recovery

Due to a concern about our MHV measurements, I'm going to start by calculating the standard deviation for our MHV recovery for each sample. MHV recovery is expressed such that 1.00 = 100% recovery.

```{r mhv std dev, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

DataSD <- DataSD[!is.na(DataSD$MHV),] #we have no Biobot MHVs drop them
DataSD$Sample <- paste(DataSD$`Laboratory`, DataSD$`Site`, DataSD$`Collection Date`, collapse=NULL) #create unique identifier

MHVStdDev <- ddply(DataSD,~Sample, summarise,`MHV Std Dev`=sd(MHV)) #std dev by the identifier
DataSD <- merge(x = DataSD, y = MHVStdDev, by = "Sample", all.x = TRUE) # merge back with original data

ggplot(DataSD, aes(x = Site, y = `MHV Std Dev`*100, fill = Site)) + theme_bw() + geom_boxplot(notch = TRUE)  +  theme(legend.position = "none")+ ylab("MHV Recovery Percent Standard Deviations (%)") + coord_flip()  

DataSD <- distinct(DataSD, `Sample`, .keep_all= TRUE)
DataSDHigh <- DataSD %>% filter(`MHV Std Dev` > 1) %>%subset(select= c(Site, `Collection Date`, `MHV Std Dev`))


knitr::kable(DataSDHigh) %>%
  kable_styling("bordered", position = "center") %>%
  kable_styling(latex_options="scale_down") 

```
Here we see the sites and dates of all samples for which the standard deviation of the MHV recovery is greater than 1 (100%) - we have a few extreme outliers of MHV recovery.


\pagebreak

## Concentrations By Site, Over Time

With our newly normalized concentrations, our values are now much closer to those of Biobot. They are, however, still a little higher than us most of the time.

```{r graphs, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}
Data$Sample <- paste(Data$`Laboratory`, Data$`Site`, Data$`Collection Date`,collapse=NULL) #create unique identifier
Data <- merge(x = Data, y = MHVStdDev, by = "Sample", all.x = TRUE) # merge back with original data

# Create a Dataset for Each Site
Wareham <- Data %>% filter(Site %in% c("Wareham WTP"))
DeerIslandN <- Data %>% filter(Site %in% c("Deer Island WTP-Northern Influent"))
DeerIslandS <- Data %>% filter(Site %in% c("Deer Island WTP-Southern Influent"))
SESD <- Data %>% filter(Site %in% c("SESD"))


#Rolling Averages

DeerIslandN <- DeerIslandN %>%
    dplyr::arrange(desc(Laboratory)) %>% 
    dplyr::group_by(Laboratory) %>% 
    dplyr::mutate(`Normalized Concentration [copies/L]` = as.double(`Normalized Concentration [copies/L]`),
                  avg_05da = zoo::rollmean(`Normalized Concentration [copies/L]`, k = 5, align="right", fill = NA)) %>% 
  mutate(Percent_Change5 = (lag(avg_05da)-avg_05da)/
           lag(avg_05da) * -100) %>% ungroup

DeerIslandS <- DeerIslandS %>%
    dplyr::arrange(desc(Laboratory)) %>% 
    dplyr::group_by(Laboratory) %>% 
    dplyr::mutate(`Normalized Concentration [copies/L]` = as.double(`Normalized Concentration [copies/L]`),
                  avg_05da = zoo::rollmean(`Normalized Concentration [copies/L]`, k = 5, align="right", fill = NA)) %>%   mutate(Percent_Change5 = (lag(avg_05da)-avg_05da)/
           lag(avg_05da) * -100) %>% ungroup

Wareham <- Wareham %>%
    dplyr::arrange(desc(Laboratory)) %>% 
    dplyr::group_by(Laboratory) %>% 
    dplyr::mutate(`Normalized Concentration [copies/L]` = as.double(`Normalized Concentration [copies/L]`),
                  avg_05da = zoo::rollmean(`Normalized Concentration [copies/L]`, k = 5, align="right", fill = NA))  %>%   mutate(Percent_Change5 = (lag(avg_05da)-avg_05da)/
           lag(avg_05da) * -100) %>% ungroup

SESD <- SESD %>%
    dplyr::arrange(desc(Laboratory)) %>% 
    dplyr::group_by(Laboratory) %>% 
    dplyr::mutate(`Normalized Concentration [copies/L]` = as.double(`Normalized Concentration [copies/L]`),
                  avg_05da = zoo::rollmean(`Normalized Concentration [copies/L]`, k = 5, align="right", fill = NA))  %>%   mutate(Percent_Change5 = (lag(avg_05da)-avg_05da)/
           lag(avg_05da) * -100) %>% ungroup


ggplot(DeerIslandN, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) + 
  labs(title="Deer Island N. SARS-CoV-2 Concentrations for MA-SPHL and Biobot") +  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)")  + theme_bw() +
  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom') 

ggplot(DeerIslandS, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) + 
  labs(title="Deer Island S. SARS-CoV-2 Concentrations for MA-SPHL and Biobot") +  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)")  + theme_bw() +
  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom') 

ggplot(Wareham, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) + 
  labs(title="Wareham WTP SARS-CoV-2 Concentrations for MA-SPHL and Biobot") +  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)")  + theme_bw() +
  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom')

ggplot(SESD, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) +
  labs(title="SESD SARS-CoV-2 Concentrations for MA-SPHL and Biobot") +  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)")  + 
  theme_bw() +
  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom')
```

\pagebreak

## Concentrations By Site, Over Time - Log Scale

Converting to a log scale, we see the same. Dates for which our standard deviation of MHV recovery was >100% are labelled.

```{r graphs log, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

ggplot(DeerIslandN, aes(x=`Collection Date`, y=log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) + 
  labs(title="Deer Island N. SARS-CoV-2 Concentrations for MA-SPHL and Biobot", subtitle = "Log Transform") +  xlab("Date") + ylab(" Log SARS-CoV-2 Concentration (log(copies/L))")  +
  theme_bw() +  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom') + geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-0.5,vjust=0, size=2.5)

ggplot(DeerIslandS, aes(x=`Collection Date`, y=log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) + 
  labs(title="Deer Island S. SARS-CoV-2 Concentrations for MA-SPHL and Biobot", subtitle = "Log Transform") +  xlab("Date") + ylab(" Log SARS-CoV-2 Concentration (log(copies/L))")  +
  theme_bw() +  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom') + geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-0.5,vjust=0, size=2.5)

ggplot(Wareham, aes(x=`Collection Date`, y= log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) + 
  labs(title="Wareham WTP SARS-CoV-2 Concentrations for MA-SPHL and Biobot", subtitle="Log Transform") +  xlab("Date") + ylab("Log SARS-CoV-2 Concentration (log(copies/L))")  + 
  theme_bw() +  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom') + geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-0.5,vjust=0, size=2.5)

SESD$Laboratory <- recode_factor(SESD$Laboratory, Biobot = "Contractor")
ggplot(SESD, aes(x=`Collection Date`, y= log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) + 
  labs(title="MA-SPHL vs. Contractor Raw Concentrations Percent Change-Site D", subtitle="Log Transform") +  xlab("Date") + ylab("Log SARS-CoV-2 Concentration (log(copies/L))")  + 
  theme_bw() +  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom')  #geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=0,vjust=0, size=2.5)
ggsave("SiteDGraph.png", units = "cm")
SESD$Laboratory <- recode_factor(SESD$Laboratory, Contractor = "Biobot")
```

\pagebreak

# Rolling Averages

Our five day rolling averages encompass each sample and the 4 samples before it (n-4 to n). Due to differences in the dates sampled between the sites, some have more days covered than others.

```{r graphs 5 day, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

ggplot(DeerIslandN, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) +
  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)") + labs(title="Deer Island North SARS-CoV-2 Concentration - Rolling 5-Day Avg") + theme_bw() + theme(legend.position='bottom') + geom_line(data = DeerIslandN, 
                       mapping = aes(x = `Collection Date`, 
                                     y = avg_05da, 
                                     color = Laboratory,
                                     ), show.legend = TRUE)

ggplot(DeerIslandS, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) +
  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)") + labs(title="Deer Island South SARS-CoV-2 Concentration - Rolling 5-Day Avg") + theme_bw() + theme(legend.position='bottom') + geom_line(data = DeerIslandS, 
                       mapping = aes(x = `Collection Date`, 
                                     y = avg_05da, 
                                     color = Laboratory,
                                     ), show.legend = TRUE)

ggplot(Wareham, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) +
  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)") + labs(title="Wareham SARS-CoV-2 Concentration - Rolling 5-Day Avg") + theme_bw() + theme(legend.position='bottom') + geom_line(data = Wareham, 
                       mapping = aes(x = `Collection Date`, 
                                     y = avg_05da, 
                                     color = Laboratory,
                                     ), show.legend = TRUE)

ggplot(SESD, aes(x=`Collection Date`, y=`Normalized Concentration [copies/L]`, group = factor(Laboratory))) +
  xlab("Date") + ylab("SARS-CoV-2 Concentration (copies/L)") + labs(title="SESD SARS-CoV-2 Concentration - Rolling 5-Day Avg") + theme_bw() + theme(legend.position='bottom') + geom_line(data = SESD, 
                       mapping = aes(x = `Collection Date`, 
                                     y = avg_05da, 
                                     color = Laboratory,
                                     ), show.legend = TRUE)
```

\pagebreak

## Rolling Averages - Log Scale

This shows the above on a log scale:

```{r graphs 5 day log , echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

ggplot(DeerIslandN, aes(x=`Collection Date`, y=log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) +
  xlab("Date") + ylab("5-Day Average Concentration (log(copies/L))") + labs(title="Deer Island N. SARS-CoV-2 Concentration - Rolling 5-Day Avg", subtitle = "Log Transform") + theme_bw() + theme(legend.position='bottom') + geom_line(data = DeerIslandN, 
                       mapping = aes(x = `Collection Date`, 
                                     y = log(avg_05da), 
                                     color = Laboratory,
                                     ), show.legend = TRUE)

ggplot(DeerIslandS, aes(x=`Collection Date`, y=log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) +
  xlab("Date") + ylab("5-Day Average Concentration (log(copies/L))") + labs(title="Deer Island S. SARS-CoV-2 Concentration - Rolling 5-Day Avg", subtitle = "Log Transform") + theme_bw() + theme(legend.position='bottom') + geom_line(data = DeerIslandS, 
                       mapping = aes(x = `Collection Date`, 
                                     y = log(avg_05da), 
                                     color = Laboratory,
                                     ), show.legend = TRUE)

ggplot(Wareham, aes(x=`Collection Date`, y=log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) +
  xlab("Date") + ylab("5-Day Average Concentration (log(copies/L))") + labs(title="Wareham SARS-CoV-2 Concentration - Rolling 5-Day Avg", subtitle="Log Transform") + theme_bw() + theme(legend.position='bottom') + geom_line(data = Wareham, 
                       mapping = aes(x = `Collection Date`, 
                                     y = log(avg_05da), 
                                     color = Laboratory,
                                     ), show.legend = TRUE)

ggplot(SESD, aes(x=`Collection Date`, y=log(`Normalized Concentration [copies/L]`), group = factor(Laboratory))) +
  xlab("Date") + ylab("5-Day Average Concentration (log(copies/L))") + labs(title="SESD SARS-CoV-2 Concentration - Rolling 5-Day Avg", subtitle="Log Transform") + theme_bw() + theme(legend.position='bottom') + geom_line(data = SESD, 
                       mapping = aes(x = `Collection Date`, 
                                     y = log(avg_05da), 
                                     color = Laboratory,
                                     ), show.legend = TRUE)


```

\pagebreak

# MA-SPHL vs. Biobot Scatter

We first plot every sample from all locations, plotting the value from MA-SPHL against that from Biobot. The first graph is of raw concentrations, while the second uses log transforms on both:

```{r graphs all vs all, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

# Reshape
AllvsAll <- select(Data, `Laboratory`, `Site`,  `Collection Date`, 
                   `Normalized Concentration [copies/L]`)
AllvsAll <- distinct(AllvsAll, `Collection Date`, Site, Laboratory, .keep_all = TRUE)
AllvsAll<- AllvsAll %>% 
  pivot_wider(names_from=c('Laboratory'), 
              values_from='Normalized Concentration [copies/L]') 

# Plot
ggplot(AllvsAll, aes(x=`Biobot`, y=`MA-SPHL`, color=Site)) + 
  labs(title="MA-SPHL vs. Biobot Concentration Measurements") +  
  xlab("Biobot Concentration (copies/L)") + 
  ylab("MA-SPHL Concentration (copies/L)")  + theme_bw() + 
  geom_smooth(method = "lm", se=FALSE, color="black") + 
  geom_point(aes(color=Site)) 

# Plot
ggplot(AllvsAll, aes(x=log(`Biobot`), y=log(`MA-SPHL`), color=Site)) + 
  labs(title="MA-SPHL vs. Biobot Concentration Measurements - Log Transform") + 
  xlab("Biobot Concentration (log(copies/L))") +   
  ylab("MA-SPHL Concentration (log(copies/L))")  +
  theme_bw() + geom_smooth(method = "lm", se=FALSE, color="black") + 
  geom_point(aes(color=Site)) 

```

The scatterplots show us that the lines of best fit are very poorly fitted to the data, so it's hard to make any definitive statement.

We can attempt logistic regression models nonetheless, examining MA-SPHL's concentration as a function of Biobot's. The first is on the raw concentration of each:

```{r all vs all model, echo=TRUE, warning=FALSE}

# No log
AllvsAllRawModel <- lm(`MA-SPHL` ~ `Biobot`, data =AllvsAll)
summary(AllvsAllRawModel)
confint(AllvsAllRawModel, 'Biobot', level=0.95)

```

We find an adjusted R-squared of 0.2444, meaning that 24.44% of the variance for the MA-SPHL measurement can be explained by its correlation with the Biobot measurement in the regression model - this is a weak fit.

The equation, however, finds a significant correlation in the concentrations found at the two labs.

Transforming concentration with a log:

```{r graphs all vs all log, echo=TRUE , warning=FALSE}

#there's a zero in there - log(0) will create errors in the model
AllvsAll <- AllvsAll[!is.infinite(log(AllvsAll$`MA-SPHL`)),] 

#Log model
AllvsAllLogModel <- lm(log(`MA-SPHL`) ~ log(`Biobot`), data=AllvsAll )
summary(AllvsAllLogModel)
confint(AllvsAllLogModel, 'log(Biobot)', level=0.95)

```

The log-transformed model has an adjusted R-squared of 15.51%, but finds a significant correlation between the two log(concentrations), with Biobot's results being 0.50 logs higher than MA-SPHL, when adjusted for intercept.

\pagebreak

# Modelling the Impact of Site and Lab

For this model, I asked R to predict the effects of our different labs and sites on the found concentration, adjusting for date.

A note on this: this model assumes linear relationships for numeric variables - here, that's the date-concentration relationship. Taking a look at the graph of concentration over time, all the sites appear to show a reasonably steady upwards climb, so I decided this was acceptable. For the categorical portions of the model (site and lab), this caveat doesn't apply.

The model uses reference levels for categoricals. R has set Deer Island North and Biobot as references by default.

```{r big all model, echo=TRUE, warning=FALSE}

BigModel <- lm(Data$`Normalized Concentration [copies/L]` ~ Data$Site + 
                 Data$Laboratory + Data$`Collection Date`)

summary(BigModel)

```

To break this down:

-   Our adjusted R-squared is 0.3553 By accounting for these variables, we can explain 35.53% of the variance in concentration seen in our samples - a weak model.

-   Significant differences were found between the sites when Deer Island North is used as reference.

-   Our concentrations decreased over time by 2920 copies/L per day on average. This doesn't tell us anything important other than confirming the changes we saw visually.

-   MA-SPHL's measurements were significantly lower than Biobot's, estimated at 412,672 copies/L lower on average. This is a very big difference.

\pagebreak

# Percent changes

Next, we look to percent changes. This allows us to get rid of the huge ratio between the two labs that we saw earlier. We can start with graphs of percent change. Dates for which our standard deviation of MHV recovery was >100% are labelled.

```{r graphs all vs all percent, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

# Reshape
AllvsAll <- select(Data, `Laboratory`, `Site`,  `Collection Date`, 
                   `Percent_Change`)
AllvsAll <- distinct(AllvsAll, `Collection Date`, Site, Laboratory, .keep_all = TRUE)
AllvsAll<- AllvsAll %>% 
  pivot_wider(names_from=c('Laboratory'), values_from='Percent_Change') 

# Plot
ggplot(AllvsAll, aes(x=`Biobot`, y=`MA-SPHL`, color=Site)) + 
  labs(title="MA-SPHL vs. Biobot Concentration Measurements") +  
  xlab("Biobot Concentration Change (%)") + 
  ylab("MA-SPHL Concentration Change (%)")  +
  theme_bw() + geom_smooth(method = "lm", se=FALSE, color="black") + 
  geom_point(aes(color=Site)) 

Data3 <- Data2 %>% group_by(Laboratory, `Collection Date`) %>% summarise(`Percent_Change` = mean(`Percent_Change`), `MHV Std Dev` = sd(MHV)) %>% ungroup
ggplot(Data3, aes(x=`Collection Date`, y=`Percent_Change`, group = factor(Laboratory))) + 
  labs(title="Averaged Daily Percent Changes - MA-SPHL and Biobot") +  xlab("Date") + ylab("Average Concentration Change Across All Sites(%)")  + 
  theme_bw() +
  geom_line(aes(color=Laboratory))+  geom_point(aes(color=Laboratory))+ theme(legend.position='bottom') + geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-1,vjust=0, size=2.5)

```

Next we conduct statistical testing, using the site-by-site percent changes (not the averaged changes):

```{r tests all vs all percent, echo=TRUE, warning=FALSE}
# Correlation
DataAnova <- lm(formula = Percent_Change ~ Laboratory, data = Data2)
anova(DataAnova)
t.test(AllvsAll$`MA-SPHL`, AllvsAll$Biobot, paired = TRUE, alternative = "two.sided")

```

Both an ANOVA and a T-test find a statistically significant difference between the percent changes of the two labs.


## Deer Island North

Filtering down to Deer Island North:

```{r pairwise percents DN, echo=TRUE , warning=FALSE}

ggplot(DeerIslandN, aes(x=`Collection Date`, y=(`Percent_Change5`), 
                       group = factor(Laboratory))) + 
  labs(title="Deer Island N. SARS-CoV-2 Concentrations Percent Changes") +  
  xlab("Date") +  ylab("Percent Change in SARS-CoV-2 Concentration (%)")  +
  theme_bw() +  geom_line(aes(color=Laboratory)) +
  geom_point(aes(color=Laboratory)) + theme(legend.position='bottom') + geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-0.4,vjust=0, size=2.5)

DeerIslandNT <- DeerIslandN[!is.na(DeerIslandN$Percent_Change5), ]
DeerIslandNT <- DeerIslandNT %>%
       filter(duplicated(`Collection Date`) | duplicated(`Collection Date`, 
                                                         fromLast=TRUE)) %>% arrange(Laboratory, `Collection Date`)

DeerIslandNT <- DeerIslandNT[!DeerIslandNT$Row=="95",]
DeerIslandNtest <- with(DeerIslandNT, t.test(Percent_Change5 ~ Laboratory, 
                                           paired=TRUE))
DeerIslandNtest

DeerIslandNAnova <- lm(formula = Percent_Change5 ~ Laboratory, data = DeerIslandN)
anova(DeerIslandNAnova)

```

Both a paired T-test and an ANOVA fail to find a significant difference between the two labs' percent change measurements at Deer Island North.

## Deer Island South

```{r pairwise percents DS, echo=TRUE , warning=FALSE}
DeerIslandS$Laboratory <- factor(DeerIslandS$Laboratory)
DeerIslandS <- DeerIslandS[!is.infinite(DeerIslandS$`Percent_Change5`),]
ggplot(DeerIslandS, aes(x=`Collection Date`, y=(`Percent_Change5`), 
                       group = factor(Laboratory))) + 
  labs(title="Deer Island S. SARS-CoV-2 Concentrations Percent Changes") +  
  xlab("Date") +  ylab("Percent Change in SARS-CoV-2 Concentration (%)")  +
  theme_bw() +  geom_line(aes(color=Laboratory)) +
  geom_point(aes(color=Laboratory)) + theme(legend.position='bottom') + geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-0.25,vjust=0, size=2.5)

DeerIslandST <- DeerIslandS %>%
       filter(duplicated(`Collection Date`) | duplicated(`Collection Date`, 
                                                         fromLast=TRUE)) %>%
       arrange(Laboratory, `Collection Date`)
DeerIslandST <- distinct(DeerIslandST, `Collection Date`, Laboratory, .keep_all = TRUE)
DeerIslandSTest <- with(DeerIslandST, t.test(Percent_Change5 ~ Laboratory, 
                                           paired=TRUE))
DeerIslandSTest

DeerIslandSAnova <- lm(formula = Percent_Change5 ~ Laboratory, data = DeerIslandS)
anova(DeerIslandSAnova)

```

Both a paired T-test and an ANOVA fail to find a significant difference between the two labs' percent change measurements at Deer Island South. The daily trend lines, however, don't seem to match in terms of which days are increases/decreases.

## Wareham

```{r pairwise percents W, echo=TRUE , warning=FALSE}

Wareham$Laboratory <- recode_factor(Wareham$Laboratory, Biobot = "Contractor")

ggplot(Wareham, aes(x=`Collection Date`, y=(`Percent_Change5`), 
                    group = factor(Laboratory))) + 
  labs(title="SARS-CoV-2 Concentrations Percent Changes - Site C") +  
  xlab("Date") + ylab("Percent Change in SARS-CoV-2 Concentration (%)")  +
  theme_bw() +  geom_line(aes(color=Laboratory))+  
  geom_point(aes(color=Laboratory)) + theme(legend.position='bottom') 
#+ geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-0.7,vjust=0, size=3)
ggsave("SiteCGraphPercent.png", units = "cm")
Wareham$Laboratory <- recode_factor(Wareham$Laboratory, Contractor = "Biobot")


WarehamT <- Wareham %>%
       filter(duplicated(`Collection Date`) | 
                duplicated(`Collection Date`, fromLast=TRUE)) %>%
       arrange(Laboratory, `Collection Date`)
WarehamT <- distinct(WarehamT, `Collection Date`, Laboratory, .keep_all = TRUE)
WarehamT <- WarehamT %>%
    dplyr::arrange(desc(Laboratory)) %>% 
    dplyr::group_by(Laboratory) %>% 
    dplyr::mutate(`Normalized Concentration [copies/L]` = as.double(`Normalized Concentration [copies/L]`),
                  avg_05da = zoo::rollmean(`Normalized Concentration [copies/L]`, k = 5, align="right", fill = NA))  %>%   mutate(Percent_Change5 = (lag(avg_05da)-avg_05da)/
           lag(avg_05da) * -100) %>% ungroup

Warehamtest <- with(WarehamT, t.test(Percent_Change5 ~ Laboratory, paired=TRUE))
Warehamtest

WarehamAnova <- lm(formula = Percent_Change5 ~ Laboratory, data = Wareham)
anova(WarehamAnova)

```

Both a paired T-test and an ANOVA fail to find a significant difference between the two labs' percent change measurements at Wareham WTP.

## SESD

```{r pairwise percents S, echo=TRUE , warning=FALSE}

ggplot(SESD, aes(x=`Collection Date`, y=(`Percent_Change5`), 
                    group = factor(Laboratory))) + 
  labs(title="SESD SARS-CoV-2 Concentrations Percent Changes") +  
  xlab("Date") + ylab("Percent Change in SARS-CoV-2 Concentration (%)")  +
  theme_bw() +  geom_line(aes(color=Laboratory))+  
  geom_point(aes(color=Laboratory)) + theme(legend.position='bottom') + geom_text(aes(label=ifelse(`MHV Std Dev`>1,as.character(`Collection Date`),'')),angle = 90, hjust=-0.1,vjust=0, size=3)

SESDT <- SESD %>%
       filter(duplicated(`Collection Date`) | 
                duplicated(`Collection Date`, fromLast=TRUE)) %>%
       arrange(Laboratory, `Collection Date`)
SESDtest <- with(SESDT, t.test(Percent_Change5 ~ Laboratory, paired=TRUE))
SESDtest

SESDAnova <- lm(formula = Percent_Change5 ~ Laboratory, data = SESD)
anova(SESDAnova)

```

Finally, SESD doesn't find any significant difference either.

# Percentiles

In the NWSS data group, some sites discussed using percentiles as a method of assessing "high" vs "low" concentrations. If Biobot measures, say, a 90th percentile concentration, we can expect that our lab would also get a high measurement for that day, so we wouldn't be finding a 20th percentile measure. This may account for procedural differences by getting down to the core aim of surveillance: is it high or low?

Here, I'll compare the percentiles between the labs for each set of samples. Percentiles are calculated with each site and lab separate - SESD samples tested by MA-SPHL have their own percentile scale, separate from SESD Biobot samples, Wareham MA-SPHL samples, etc.

```{r percentiles , echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

#Dplyr updated their ntile to make it garbage. Copying from the internet to recreate the old good version.
ntile_083 <- function (x = row_number(), n) {  
  len <- sum(!is.na(x))
  if (len == 0L) {
    rep(NA_integer_, length(x))
  } else {
    as.integer(floor(n * (row_number(x) - 1)/len + 1))
  }
}

Data <- Data %>% group_by(Laboratory, Site) %>%
  mutate(ConcPercentile = ntile_083(`Normalized Concentration [copies/L]`, 100))

# Reshape
AllvsAllPerc <- select(Data, `Laboratory`, `Site`,  `Collection Date`, 
                   `ConcPercentile`)
AllvsAllPerc <- distinct(AllvsAllPerc, `Collection Date`, Site, Laboratory, .keep_all = TRUE)

AllvsAllPerc<- AllvsAllPerc %>% 
  pivot_wider(names_from=c('Laboratory'), 
              values_from='ConcPercentile') 

# Plot
ggplot(AllvsAllPerc, aes(x=`Biobot`, y=`MA-SPHL`, color=Site)) + 
  labs(title="MA-SPHL vs. Biobot Concentration Percentiles") +  
  xlab("Biobot Concentration (%ile)") + geom_smooth(method = "lm", se=FALSE, color="black") + 
  ylab("MA-SPHL Concentration (%ile)")  + theme_bw() + 
  geom_point(aes(color=Site)) 
```

```{r pairwise percentiles, echo=TRUE , warning=FALSE}

cor.test(AllvsAllPerc$`MA-SPHL`, AllvsAllPerc$Biobot,
         method = "spearman")

```

R finds a rho of 0.405 and  a p-value of 3.829*10^-9 - a moderate correlation, but significant.


# Concentration Ratios

From a public health perspective, the raw SARS-CoV-2 concentrations we're measuring here don't really matter. Rather, percent changes are what should be a factor in decision-making, so regardless of whether the measurements are in the 10,000 or 1,000,000 range, if the two labs capture the same proportional rises and falls, that should be satisfactory. 


These graphs will average all sites' raw concentrations, finding the ratio of measurements between the two labs. I will do this on both a day-by-day (ex. ratio for 6/01) and a aggregate basis (ratio of the sum of all measurements 4/25-now).

## Daily Ratio

For each day sampled, we find:

$\frac{(MA-SPHL)}{(Biobot)}$

```{r raw ratio,echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

DataWide <- Data %>% select(`Collection Date`, Site, Laboratory, `Normalized Concentration [copies/L]`)
DataWide <- distinct(DataWide, `Collection Date`, Site, Laboratory, .keep_all = TRUE)
DataWide <- DataWide %>%  pivot_wider(names_from=c('Site'), 
              values_from='Normalized Concentration [copies/L]') 
DataWide$DaySum <- rowSums(DataWide[,-c(1,2)], na.rm = TRUE)

DataWide2 <- DataWide %>% select(`Collection Date`, Laboratory, DaySum)
DataWide2 <- DataWide2 %>%  pivot_wider(names_from=c('Laboratory'), 
              values_from='DaySum') 

DataWide2$DayRatio <- DataWide2$`MA-SPHL`/DataWide2$Biobot

ggplot(DataWide2, aes(x=`Collection Date`, y=DayRatio)) + 
  labs(title="Day-by-Day Ratio of Average Concentrations Between Labs") +  xlab("Date") + ylab("Ratio Between Concentrations (MA-SPHL/Biobot")  + theme_bw() + geom_point()+ theme(legend.position='bottom') + geom_smooth(method = "lm", se=FALSE, color="red") 


```

```{r raw ratio model, echo=TRUE , warning=FALSE}

DataWide2$CumuMASPHL <- cumsum(DataWide2$`MA-SPHL`)
DataWide2$CumuBiobot <- cumsum(DataWide2$Biobot)
DataWide2$CumuRatio <- DataWide2$CumuMASPHL/DataWide2$CumuBiobot
RatLong <- DataWide2 %>% 
  select('Collection Date', CumuRatio, DayRatio) 

Rat <- lm(formula = DayRatio ~ `Collection Date`, data = RatLong)
summary(Rat)

```

A model finds the ratio to change significantly but slightly over time, decreasing by 0.225% per day


## Aggregated Ratio

We can also look at this ratio on a aggregate basis. For each day sampled, we find:

$\frac{\sum_{i=1}^{n}(MA-SPHLc)}{\sum_{i=1}^{n} (Biobot)}$

where i=1 is day 1 of sampling (4/25). For each day, this gives us what the "average so far" was for that day. This is closer to what the reports were seeing - with the addition of new data, models kept finding a lower and lower ratio between the two labs' results. 

Theoretically, the average should not be changing over time, just stabilize. We can graph this below:

```{r rolling ratio, echo=FALSE , warning=FALSE, message=FALSE, results = "asis", type = 'latex'}

ggplot(DataWide2, aes(x=`Collection Date`, y=CumuRatio)) + 
  labs(title="Cumulative Ratio of Average Concentrations Between Labs") +  xlab("Date") + ylab("Ratio Between Concentrations (MA-SPHL/Biobot)")  + theme_bw() + geom_point()+ theme(legend.position='bottom') + geom_smooth(method = "lm", se=FALSE, color="red") 

```

This looks very wiggly, but it stabilizes. We can test this:

```{r rolling ratio model, echo=TRUE , warning=FALSE}

RollRat <- lm(formula = CumuRatio ~ `Collection Date`, data = RatLong)
summary(RollRat)

```

A regression model finds this ratio to  change slightly but significantly over time, decreasing 0.13% per day.


# Conclusions

## Concentrations Over Time and Rolling Averages

In the first two sections, we display graphs of the site-by-site measurements with both Biobot and MA-SPHL, both as raw measurements and 5-day rolling averages. We note that the Biobot effective concentrations finally seem to match MA-SPHL. 

## Modelling the Impact of Site and Lab

This model determined that our results were 412,672 copies/L lower on average than Biobot, with a slight but significant decrease over time for both labs. Additionally, the model found no significant differences in findings between labs.

## T-Tests and ANOVAs of Percent Changes

For all sites, both T-Tests and Analyses of Variance (ANOVAs) failed to find significant differences between the two labs.

A very important note: the null hypothesis of both tests is that there's no difference between the sites. In general, statistical testing assumes things to be the same until proven otherwise, meaning that the percent changes of the sites being "different" has an uphill battle, as the burden of proof is on the alternative hypothesis.

## Percentiles

The two labs' percentiles were found to be moderately but significantly correlated.

## Ratios

An examination of the ratio between the labs' findings found slight decreases over the time period sampled for either daily or aggregate ratios.

## In short:

These results look much better than before. 



